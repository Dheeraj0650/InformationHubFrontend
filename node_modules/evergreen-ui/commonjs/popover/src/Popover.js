'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _extends = Object.assign || function (target) { for (var i = 1; i < arguments.length; i++) { var source = arguments[i]; for (var key in source) { if (Object.prototype.hasOwnProperty.call(source, key)) { target[key] = source[key]; } } } return target; };

var _createClass = function () { function defineProperties(target, props) { for (var i = 0; i < props.length; i++) { var descriptor = props[i]; descriptor.enumerable = descriptor.enumerable || false; descriptor.configurable = true; if ("value" in descriptor) descriptor.writable = true; Object.defineProperty(target, descriptor.key, descriptor); } } return function (Constructor, protoProps, staticProps) { if (protoProps) defineProperties(Constructor.prototype, protoProps); if (staticProps) defineProperties(Constructor, staticProps); return Constructor; }; }();

var _react = require('react');

var _react2 = _interopRequireDefault(_react);

var _propTypes = require('prop-types');

var _propTypes2 = _interopRequireDefault(_propTypes);

var _positioner = require('../../positioner');

var _PopoverStateless = require('./PopoverStateless');

var _PopoverStateless2 = _interopRequireDefault(_PopoverStateless);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function _objectWithoutProperties(obj, keys) { var target = {}; for (var i in obj) { if (keys.indexOf(i) >= 0) continue; if (!Object.prototype.hasOwnProperty.call(obj, i)) continue; target[i] = obj[i]; } return target; }

function _classCallCheck(instance, Constructor) { if (!(instance instanceof Constructor)) { throw new TypeError("Cannot call a class as a function"); } }

function _possibleConstructorReturn(self, call) { if (!self) { throw new ReferenceError("this hasn't been initialised - super() hasn't been called"); } return call && (typeof call === "object" || typeof call === "function") ? call : self; }

function _inherits(subClass, superClass) { if (typeof superClass !== "function" && superClass !== null) { throw new TypeError("Super expression must either be null or a function, not " + typeof superClass); } subClass.prototype = Object.create(superClass && superClass.prototype, { constructor: { value: subClass, enumerable: false, writable: true, configurable: true } }); if (superClass) Object.setPrototypeOf ? Object.setPrototypeOf(subClass, superClass) : subClass.__proto__ = superClass; }

var Popover = function (_Component) {
  _inherits(Popover, _Component);

  function Popover() {
    _classCallCheck(this, Popover);

    var _this = _possibleConstructorReturn(this, (Popover.__proto__ || Object.getPrototypeOf(Popover)).call(this));

    _this.onBodyClick = function (e) {
      // Ignore clicks on the popover or button
      if (_this.targetNode === e.target) {
        return;
      }

      if (_this.popoverNode && (_this.popoverNode === e.target || _this.popoverNode.contains(e.target))) {
        return;
      }

      _this.close();
    };

    _this.onResize = function () {
      _this.close();
    };

    _this.onEsc = function (e) {
      // Esc key
      if (e.keyCode === 27) {
        _this.close();
      }
    };

    _this.getRef = function (ref) {
      _this.targetNode = ref;
    };

    _this.getTargetRect = function () {
      return _this.targetNode.getBoundingClientRect();
    };

    _this.toggle = function () {
      var isOpen = !_this.state.isOpen;

      if (isOpen) {
        _this.open();
      } else {
        _this.close();
      }

      _this.setState({ isOpen: isOpen });
    };

    _this.open = function () {
      if (_this.state.isOpen) {
        return;
      }

      _this.setState({ isOpen: true, targetRect: _this.getTargetRect() });
      document.body.addEventListener('click', _this.onBodyClick, false);
      document.body.addEventListener('keydown', _this.onEsc, false);
      window.addEventListener('resize', _this.onResize, false);

      _this.props.onOpen();
    };

    _this.close = function () {
      if (!_this.state.isOpen) {
        return;
      }

      _this.setState({ isOpen: false });
      document.body.removeEventListener('click', _this.onBodyClick, false);
      document.body.removeEventListener('keydown', _this.onEsc, false);
      window.removeEventListener('resize', _this.resize, false);

      _this.props.onClose();
    };

    _this.state = {
      isOpen: false,
      targetRect: {}
    };
    return _this;
  }

  _createClass(Popover, [{
    key: 'componentWillReceiveProps',
    value: function componentWillReceiveProps(nextProps) {
      if (Object.prototype.hasOwnProperty.call(nextProps, 'isOpen')) {
        if (nextProps.isOpen) {
          this.setState({
            targetRect: this.getTargetRect()
          });
        }
      }
    }
  }, {
    key: 'componentWillUnmount',
    value: function componentWillUnmount() {
      document.body.removeEventListener('click', this.onBodyClick, false);
      document.body.removeEventListener('keydown', this.onEsc, false);
      window.removeEventListener('resize', this.resize, false);
    }
  }, {
    key: 'render',
    value: function render() {
      var _this2 = this;

      var _props = this.props,
          zIndex = _props.zIndex,
          isOpen = _props.isOpen,
          content = _props.content,
          display = _props.display,
          children = _props.children,
          minWidth = _props.minWidth,
          minHeight = _props.minHeight,
          statelessProps = _props.statelessProps,
          props = _objectWithoutProperties(_props, ['zIndex', 'isOpen', 'content', 'display', 'children', 'minWidth', 'minHeight', 'statelessProps']);

      var _state = this.state,
          stateIsOpen = _state.isOpen,
          targetRect = _state.targetRect;


      var open = isOpen || stateIsOpen;

      return [typeof children === 'function' ? children({
        targetRect: targetRect,
        toggle: this.toggle,
        getRef: this.getRef,
        isOpen: open,
        key: 'popover-child'
      }) : _react2.default.cloneElement(children, _extends({
        onClick: function onClick() {
          return _this2.toggle();
        },
        innerRef: function innerRef(ref) {
          _this2.getRef(ref);
        }
      }, open ? { 'data-popover-opened': true } : {}, {
        key: 'popover-child'
      })), _react2.default.createElement(
        _positioner.Positioner,
        _extends({
          key: 'popover-positioner',
          targetRect: targetRect,
          zIndex: zIndex,
          isShown: open
        }, props),
        function (_ref) {
          var css = _ref.css,
              style = _ref.style,
              state = _ref.state,
              getRef = _ref.getRef;
          return _react2.default.createElement(
            _PopoverStateless2.default,
            _extends({
              innerRef: function innerRef(ref) {
                _this2.popoverNode = ref;
                getRef(ref);
              },
              'data-state': state,
              css: css,
              style: style,
              display: display,
              minWidth: minWidth,
              minHeight: minHeight
            }, statelessProps),
            typeof content === 'function' ? content({ targetRect: targetRect, close: _this2.close }) : content
          );
        }
      )];
    }
  }]);

  return Popover;
}(_react.Component);

Popover.propTypes = _extends({}, _positioner.Positioner.propTypes, {
  onOpen: _propTypes2.default.func.isRequired,
  // Use isOpen to manually control the Popover
  isOpen: _propTypes2.default.bool,
  onClose: _propTypes2.default.func.isRequired,
  content: _propTypes2.default.oneOfType([_propTypes2.default.node, _propTypes2.default.func]).isRequired,
  children: _propTypes2.default.oneOfType([_propTypes2.default.element, _propTypes2.default.func]).isRequired,
  display: _propTypes2.default.string,
  minWidth: _propTypes2.default.oneOfType([_propTypes2.default.number, _propTypes2.default.string]),
  minHeight: _propTypes2.default.oneOfType([_propTypes2.default.number, _propTypes2.default.string]),
  statelessProps: _propTypes2.default.objectOf(_PopoverStateless2.default.propTypes)
});
Popover.defaultProps = {
  side: 'bottom',
  onOpen: function onOpen() {},
  onClose: function onClose() {},
  minWidth: 200,
  minHeight: 40
};
exports.default = Popover;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uL3NyYy9wb3BvdmVyL3NyYy9Qb3BvdmVyLmpzIl0sIm5hbWVzIjpbIlBvcG92ZXIiLCJvbkJvZHlDbGljayIsInRhcmdldE5vZGUiLCJlIiwidGFyZ2V0IiwicG9wb3Zlck5vZGUiLCJjb250YWlucyIsImNsb3NlIiwib25SZXNpemUiLCJvbkVzYyIsImtleUNvZGUiLCJnZXRSZWYiLCJyZWYiLCJnZXRUYXJnZXRSZWN0IiwiZ2V0Qm91bmRpbmdDbGllbnRSZWN0IiwidG9nZ2xlIiwiaXNPcGVuIiwic3RhdGUiLCJvcGVuIiwic2V0U3RhdGUiLCJ0YXJnZXRSZWN0IiwiZG9jdW1lbnQiLCJib2R5IiwiYWRkRXZlbnRMaXN0ZW5lciIsIndpbmRvdyIsInByb3BzIiwib25PcGVuIiwicmVtb3ZlRXZlbnRMaXN0ZW5lciIsInJlc2l6ZSIsIm9uQ2xvc2UiLCJuZXh0UHJvcHMiLCJPYmplY3QiLCJwcm90b3R5cGUiLCJoYXNPd25Qcm9wZXJ0eSIsImNhbGwiLCJ6SW5kZXgiLCJjb250ZW50IiwiZGlzcGxheSIsImNoaWxkcmVuIiwibWluV2lkdGgiLCJtaW5IZWlnaHQiLCJzdGF0ZWxlc3NQcm9wcyIsInN0YXRlSXNPcGVuIiwia2V5IiwiY2xvbmVFbGVtZW50Iiwib25DbGljayIsImlubmVyUmVmIiwiY3NzIiwic3R5bGUiLCJwcm9wVHlwZXMiLCJmdW5jIiwiaXNSZXF1aXJlZCIsImJvb2wiLCJvbmVPZlR5cGUiLCJub2RlIiwiZWxlbWVudCIsInN0cmluZyIsIm51bWJlciIsIm9iamVjdE9mIiwiZGVmYXVsdFByb3BzIiwic2lkZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7QUFDQTs7Ozs7Ozs7Ozs7Ozs7SUFFcUJBLE87OztBQXdCbkIscUJBQWM7QUFBQTs7QUFBQTs7QUFBQSxVQXdCZEMsV0F4QmMsR0F3QkEsYUFBSztBQUNqQjtBQUNBLFVBQUksTUFBS0MsVUFBTCxLQUFvQkMsRUFBRUMsTUFBMUIs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QyxvQkFBVUksTUFBWCxFQUFtQixvQkFBVUQsTUFBN0IsQ0FBcEIsQztBQUNWaEIsYUFBVyxvQkFBVWEsU0FBVixDQUFvQixDQUFDLG9CQUFVSSxNQUFYLEVBQW1CLG9CQUFVRCxNQUE3QixDQUFwQixDO0FBQ1hmLGtCQUFnQixvQkFBVWlCLFFBQVYsQ0FBbUIsMkJBQWlCVCxTQUFwQzs7QUFiQ2pELE8sQ0FnQloyRCxZLEdBQWU7QUFDcEJDLFFBQU0sUUFEYztBQUVwQmxDLFVBQVEsa0JBQU0sQ0FBRSxDQUZJO0FBR3BCRyxXQUFTLG1CQUFNLENBQUUsQ0FIRztBQUlwQlUsWUFBVSxHQUpVO0FBS3BCQyxhQUFXO0FBTFMsQztrQkFoQkh4QyxPIiwiZmlsZSI6IlBvcG92ZXIuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUmVhY3QsIHsgQ29tcG9uZW50IH0gZnJvbSAncmVhY3QnXG5pbXBvcnQgUHJvcFR5cGVzIGZyb20gJ3Byb3AtdHlwZXMnXG5pbXBvcnQgeyBQb3NpdGlvbmVyIH0gZnJvbSAnLi4vLi4vcG9zaXRpb25lcidcbmltcG9ydCBQb3BvdmVyU3RhdGVsZXNzIGZyb20gJy4vUG9wb3ZlclN0YXRlbGVzcydcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgUG9wb3ZlciBleHRlbmRzIENvbXBvbmVudCB7XG4gIHN0YXRpYyBwcm9wVHlwZXMgPSB7XG4gICAgLi4uUG9zaXRpb25lci5wcm9wVHlwZXMsXG4gICAgb25PcGVuOiBQcm9wVHlwZXMuZnVuYy5pc1JlcXVpcmVkLFxuICAgIC8vIFVzZSBpc09wZW4gdG8gbWFudWFsbHkgY29udHJvbCB0aGUgUG9wb3ZlclxuICAgIGlzT3BlbjogUHJvcFR5cGVzLmJvb2wsXG4gICAgb25DbG9zZTogUHJvcFR5cGVzLmZ1bmMuaXNSZXF1aXJlZCxcbiAgICBjb250ZW50OiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMubm9kZSwgUHJvcFR5cGVzLmZ1bmNdKS5pc1JlcXVpcmVkLFxuICAgIGNoaWxkcmVuOiBQcm9wVHlwZXMub25lT2ZUeXBlKFtQcm9wVHlwZXMuZWxlbWVudCwgUHJvcFR5cGVzLmZ1bmNdKVxuICAgICAgLmlzUmVxdWlyZWQsXG4gICAgZGlzcGxheTogUHJvcFR5cGVzLnN0cmluZyxcbiAgICBtaW5XaWR0aDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm51bWJlciwgUHJvcFR5cGVzLnN0cmluZ10pLFxuICAgIG1pbkhlaWdodDogUHJvcFR5cGVzLm9uZU9mVHlwZShbUHJvcFR5cGVzLm51bWJlciwgUHJvcFR5cGVzLnN0cmluZ10pLFxuICAgIHN0YXRlbGVzc1Byb3BzOiBQcm9wVHlwZXMub2JqZWN0T2YoUG9wb3ZlclN0YXRlbGVzcy5wcm9wVHlwZXMpXG4gIH1cblxuICBzdGF0aWMgZGVmYXVsdFByb3BzID0ge1xuICAgIHNpZGU6ICdib3R0b20nLFxuICAgIG9uT3BlbjogKCkgPT4ge30sXG4gICAgb25DbG9zZTogKCkgPT4ge30sXG4gICAgbWluV2lkdGg6IDIwMCxcbiAgICBtaW5IZWlnaHQ6IDQwXG4gIH1cblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpXG4gICAgdGhpcy5zdGF0ZSA9IHtcbiAgICAgIGlzT3BlbjogZmFsc2UsXG4gICAgICB0YXJnZXRSZWN0OiB7fVxuICAgIH1cbiAgfVxuXG4gIGNvbXBvbmVudFdpbGxSZWNlaXZlUHJvcHMobmV4dFByb3BzKSB7XG4gICAgaWYgKE9iamVjdC5wcm90b3R5cGUuaGFzT3duUHJvcGVydHkuY2FsbChuZXh0UHJvcHMsICdpc09wZW4nKSkge1xuICAgICAgaWYgKG5leHRQcm9wcy5pc09wZW4pIHtcbiAgICAgICAgdGhpcy5zZXRTdGF0ZSh7XG4gICAgICAgICAgdGFyZ2V0UmVjdDogdGhpcy5nZXRUYXJnZXRSZWN0KClcbiAgICAgICAgfSlcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICBjb21wb25lbnRXaWxsVW5tb3VudCgpIHtcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2NsaWNrJywgdGhpcy5vbkJvZHlDbGljaywgZmFsc2UpXG4gICAgZG9jdW1lbnQuYm9keS5yZW1vdmVFdmVudExpc3RlbmVyKCdrZXlkb3duJywgdGhpcy5vbkVzYywgZmFsc2UpXG4gICAgd2luZG93LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ3Jlc2l6ZScsIHRoaXMucmVzaXplLCBmYWxzZSlcbiAgfVxuXG4gIG9uQm9keUNsaWNrID0gZSA9PiB7XG4gICAgLy8gSWdub3JlIGNsaWNrcyBvbiB0aGUgcG9wb3ZlciBvciBidXR0b25cbiAgICBpZiAodGhpcy50YXJnZXROb2RlID09PSBlLnRhcmdldCkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgaWYgKFxuICAgICAgdGhpcy5wb3BvdmVyTm9kZSAmJlxuICAgICAgKHRoaXMucG9wb3Zlck5vZGUgPT09IGUudGFyZ2V0IHx8IHRoaXMucG9wb3Zlck5vZGUuY29udGFpbnMoZS50YXJnZXQpKVxuICAgICkge1xuICAgICAgcmV0dXJuXG4gICAgfVxuXG4gICAgdGhpcy5jbG9zZSgpXG4gIH1cblxuICBvblJlc2l6ZSA9ICgpID0+IHtcbiAgICB0aGlzLmNsb3NlKClcbiAgfVxuXG4gIG9uRXNjID0gZSA9PiB7XG4gICAgLy8gRXNjIGtleVxuICAgIGlmIChlLmtleUNvZGUgPT09IDI3KSB7XG4gICAgICB0aGlzLmNsb3NlKClcbiAgICB9XG4gIH1cblxuICBnZXRSZWYgPSByZWYgPT4ge1xuICAgIHRoaXMudGFyZ2V0Tm9kZSA9IHJlZlxuICB9XG5cbiAgZ2V0VGFyZ2V0UmVjdCA9ICgpID0+IHRoaXMudGFyZ2V0Tm9kZS5nZXRCb3VuZGluZ0NsaWVudFJlY3QoKVxuXG4gIHRvZ2dsZSA9ICgpID0+IHtcbiAgICBjb25zdCBpc09wZW4gPSAhdGhpcy5zdGF0ZS5pc09wZW5cblxuICAgIGlmIChpc09wZW4pIHtcbiAgICAgIHRoaXMub3BlbigpXG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuY2xvc2UoKVxuICAgIH1cblxuICAgIHRoaXMuc2V0U3RhdGUoeyBpc09wZW4gfSlcbiAgfVxuXG4gIG9wZW4gPSAoKSA9PiB7XG4gICAgaWYgKHRoaXMuc3RhdGUuaXNPcGVuKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHsgaXNPcGVuOiB0cnVlLCB0YXJnZXRSZWN0OiB0aGlzLmdldFRhcmdldFJlY3QoKSB9KVxuICAgIGRvY3VtZW50LmJvZHkuYWRkRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQm9keUNsaWNrLCBmYWxzZSlcbiAgICBkb2N1bWVudC5ib2R5LmFkZEV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm9uRXNjLCBmYWxzZSlcbiAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5vblJlc2l6ZSwgZmFsc2UpXG5cbiAgICB0aGlzLnByb3BzLm9uT3BlbigpXG4gIH1cblxuICBjbG9zZSA9ICgpID0+IHtcbiAgICBpZiAoIXRoaXMuc3RhdGUuaXNPcGVuKSB7XG4gICAgICByZXR1cm5cbiAgICB9XG5cbiAgICB0aGlzLnNldFN0YXRlKHsgaXNPcGVuOiBmYWxzZSB9KVxuICAgIGRvY3VtZW50LmJvZHkucmVtb3ZlRXZlbnRMaXN0ZW5lcignY2xpY2snLCB0aGlzLm9uQm9keUNsaWNrLCBmYWxzZSlcbiAgICBkb2N1bWVudC5ib2R5LnJlbW92ZUV2ZW50TGlzdGVuZXIoJ2tleWRvd24nLCB0aGlzLm9uRXNjLCBmYWxzZSlcbiAgICB3aW5kb3cucmVtb3ZlRXZlbnRMaXN0ZW5lcigncmVzaXplJywgdGhpcy5yZXNpemUsIGZhbHNlKVxuXG4gICAgdGhpcy5wcm9wcy5vbkNsb3NlKClcbiAgfVxuXG4gIHJlbmRlcigpIHtcbiAgICBjb25zdCB7XG4gICAgICB6SW5kZXgsXG4gICAgICBpc09wZW4sXG4gICAgICBjb250ZW50LFxuICAgICAgZGlzcGxheSxcbiAgICAgIGNoaWxkcmVuLFxuICAgICAgbWluV2lkdGgsXG4gICAgICBtaW5IZWlnaHQsXG4gICAgICBzdGF0ZWxlc3NQcm9wcyxcbiAgICAgIC4uLnByb3BzXG4gICAgfSA9IHRoaXMucHJvcHNcbiAgICBjb25zdCB7IGlzT3Blbjogc3RhdGVJc09wZW4sIHRhcmdldFJlY3QgfSA9IHRoaXMuc3RhdGVcblxuICAgIGNvbnN0IG9wZW4gPSBpc09wZW4gfHwgc3RhdGVJc09wZW5cblxuICAgIHJldHVybiBbXG4gICAgICB0eXBlb2YgY2hpbGRyZW4gPT09ICdmdW5jdGlvbidcbiAgICAgICAgPyBjaGlsZHJlbih7XG4gICAgICAgICAgICB0YXJnZXRSZWN0LFxuICAgICAgICAgICAgdG9nZ2xlOiB0aGlzLnRvZ2dsZSxcbiAgICAgICAgICAgIGdldFJlZjogdGhpcy5nZXRSZWYsXG4gICAgICAgICAgICBpc09wZW46IG9wZW4sXG4gICAgICAgICAgICBrZXk6ICdwb3BvdmVyLWNoaWxkJ1xuICAgICAgICAgIH0pXG4gICAgICAgIDogUmVhY3QuY2xvbmVFbGVtZW50KGNoaWxkcmVuLCB7XG4gICAgICAgICAgICBvbkNsaWNrOiAoKSA9PiB0aGlzLnRvZ2dsZSgpLFxuICAgICAgICAgICAgaW5uZXJSZWY6IHJlZiA9PiB7XG4gICAgICAgICAgICAgIHRoaXMuZ2V0UmVmKHJlZilcbiAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAuLi4ob3BlbiA/IHsgJ2RhdGEtcG9wb3Zlci1vcGVuZWQnOiB0cnVlIH0gOiB7fSksXG4gICAgICAgICAgICBrZXk6ICdwb3BvdmVyLWNoaWxkJ1xuICAgICAgICAgIH0pLFxuXG4gICAgICA8UG9zaXRpb25lclxuICAgICAgICBrZXk9XCJwb3BvdmVyLXBvc2l0aW9uZXJcIlxuICAgICAgICB0YXJnZXRSZWN0PXt0YXJnZXRSZWN0fVxuICAgICAgICB6SW5kZXg9e3pJbmRleH1cbiAgICAgICAgaXNTaG93bj17b3Blbn1cbiAgICAgICAgey4uLnByb3BzfVxuICAgICAgPlxuICAgICAgICB7KHsgY3NzLCBzdHlsZSwgc3RhdGUsIGdldFJlZiB9KSA9PiAoXG4gICAgICAgICAgPFBvcG92ZXJTdGF0ZWxlc3NcbiAgICAgICAgICAgIGlubmVyUmVmPXtyZWYgPT4ge1xuICAgICAgICAgICAgICB0aGlzLnBvcG92ZXJOb2RlID0gcmVmXG4gICAgICAgICAgICAgIGdldFJlZihyZWYpXG4gICAgICAgICAgICB9fVxuICAgICAgICAgICAgZGF0YS1zdGF0ZT17c3RhdGV9XG4gICAgICAgICAgICBjc3M9e2Nzc31cbiAgICAgICAgICAgIHN0eWxlPXtzdHlsZX1cbiAgICAgICAgICAgIGRpc3BsYXk9e2Rpc3BsYXl9XG4gICAgICAgICAgICBtaW5XaWR0aD17bWluV2lkdGh9XG4gICAgICAgICAgICBtaW5IZWlnaHQ9e21pbkhlaWdodH1cbiAgICAgICAgICAgIHsuLi5zdGF0ZWxlc3NQcm9wc31cbiAgICAgICAgICA+XG4gICAgICAgICAgICB7dHlwZW9mIGNvbnRlbnQgPT09ICdmdW5jdGlvbidcbiAgICAgICAgICAgICAgPyBjb250ZW50KHsgdGFyZ2V0UmVjdCwgY2xvc2U6IHRoaXMuY2xvc2UgfSlcbiAgICAgICAgICAgICAgOiBjb250ZW50fVxuICAgICAgICAgIDwvUG9wb3ZlclN0YXRlbGVzcz5cbiAgICAgICAgKX1cbiAgICAgIDwvUG9zaXRpb25lcj5cbiAgICBdXG4gIH1cbn1cbiJdfQ==